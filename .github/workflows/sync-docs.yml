name: Sync Docs from DmNote

on:
  # ë§¤ì¼ UTC ê¸°ì¤€ 00:00ì— ì‹¤í–‰ (í•œêµ­ ì‹œê°„ 09:00)
  schedule:
    - cron: "0 0 * * *"

  # ìˆ˜ë™ ì‹¤í–‰ ê°€ëŠ¥
  workflow_dispatch:

  # ì›ë³¸ ë ˆí¬ì—ì„œ íŠ¸ë¦¬ê±° (docs/content ë³€ê²½ ì‹œ)
  repository_dispatch:
    types: [docs-updated]

jobs:
  sync-docs:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout DmSite (í˜„ì¬ ë ˆí¬)
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          path: dmsite

      - name: Checkout DmNote (ì›ë³¸ ë ˆí¬)
        uses: actions/checkout@v4
        with:
          repository: DmNote-App/DmNote
          path: dmnote
          sparse-checkout: |
            docs/content
          sparse-checkout-cone-mode: false

      - name: Sync docs/content to src/content
        run: |
          # ê¸°ì¡´ src/content ë‚´ìš© ì‚­ì œ (ë™ê¸°í™”ë¥¼ ìœ„í•´, READMEëŠ” ìœ ì§€)
          if [ -f "dmsite/src/content/README.md" ]; then
            cp dmsite/src/content/README.md /tmp/README.md.bak
            echo "ğŸ“¦ README.md ë°±ì—… ì™„ë£Œ"
          fi

          rm -rf dmsite/src/content/*

          # ë””ë ‰í† ë¦¬ êµ¬ì¡° ìƒì„±
          mkdir -p dmsite/src/content/ko
          mkdir -p dmsite/src/content/en

          # DmNoteì˜ docs/content/{ko,en}/* â†’ DmSiteì˜ src/content/{ko,en}/*
          if [ -d "dmnote/docs/content/ko" ]; then
            cp -r dmnote/docs/content/ko/* dmsite/src/content/ko/
            echo "âœ… í•œêµ­ì–´ ë¬¸ì„œ ë™ê¸°í™” ì™„ë£Œ"
          else
            echo "âš ï¸ dmnote/docs/content/ko í´ë”ê°€ ì¡´ì¬í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤"
            exit 1
          fi

          if [ -d "dmnote/docs/content/en" ]; then
            cp -r dmnote/docs/content/en/* dmsite/src/content/en/
            echo "âœ… ì˜ì–´ ë¬¸ì„œ ë™ê¸°í™” ì™„ë£Œ"
          else
            echo "âš ï¸ dmnote/docs/content/en í´ë”ê°€ ì¡´ì¬í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤"
            exit 1
          fi

          # Nextra content directory ì»¨ë²¤ì…˜: page.mdx â†’ index.mdx
          # (DmNoteëŠ” app-router ìŠ¤íƒ€ì¼(page.mdx)ë¡œ ê´€ë¦¬, DmSiteëŠ” content-dir ìŠ¤íƒ€ì¼(index.mdx)ë¡œ ë Œë”ë§)
          find dmsite/src/content -type f -name 'page.mdx' -print0 | while IFS= read -r -d '' file; do
            dir="$(dirname "$file")"
            mv "$file" "$dir/index.mdx"
          done

          # README ë³µì›
          if [ -f "/tmp/README.md.bak" ]; then
            cp /tmp/README.md.bak dmsite/src/content/README.md
            echo "ğŸ“¦ README.md ë³µì› ì™„ë£Œ"
          fi

      - name: Check for changes
        id: check_changes
        run: |
          cd dmsite
          git add -A
          if git diff --staged --quiet; then
            echo "changes=false" >> $GITHUB_OUTPUT
            echo "ğŸ“ ë³€ê²½ì‚¬í•­ì´ ì—†ìŠµë‹ˆë‹¤"
          else
            echo "changes=true" >> $GITHUB_OUTPUT
            echo "ğŸ“ ë³€ê²½ì‚¬í•­ì´ ë°œê²¬ë˜ì—ˆìŠµë‹ˆë‹¤"
          fi

      - name: Commit and Push changes
        if: steps.check_changes.outputs.changes == 'true'
        run: |
          cd dmsite
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git commit -m "docs: DmNoteì—ì„œ ë¬¸ì„œ ë™ê¸°í™” [ìë™]"
          git push
