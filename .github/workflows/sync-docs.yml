name: Sync Docs from DmNote

on:
  # ë§¤ì¼ UTC ê¸°ì¤€ 00:00ì— ì‹¤í–‰ (í•œêµ­ ì‹œê°„ 09:00)
  schedule:
    - cron: "0 0 * * *"

  # ìˆ˜ë™ ì‹¤í–‰ ê°€ëŠ¥
  workflow_dispatch:

  # ì›ë³¸ ë ˆí¬ì—ì„œ íŠ¸ë¦¬ê±° (docs/plugin ë³€ê²½ ì‹œ)
  repository_dispatch:
    types: [docs-updated]

jobs:
  sync-docs:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout DmSite (í˜„ì¬ ë ˆí¬)
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          path: dmsite

      - name: Checkout DmNote (ì›ë³¸ ë ˆí¬)
        uses: actions/checkout@v4
        with:
          repository: DmNote-App/DmNote
          path: dmnote
          sparse-checkout: |
            docs/plugin
          sparse-checkout-cone-mode: false

      - name: Sync docs/plugin to src/app/docs
        run: |
          # layout.jsx ë°±ì—… (Nextraì—ì„œ í•„ìš”í•œ íŒŒì¼)
          if [ -f "dmsite/src/app/docs/layout.jsx" ]; then
            cp dmsite/src/app/docs/layout.jsx /tmp/layout.jsx.bak
            echo "ğŸ“¦ layout.jsx ë°±ì—… ì™„ë£Œ"
          fi

          # ê¸°ì¡´ src/app/docs ë‚´ìš© ì‚­ì œ (ë™ê¸°í™”ë¥¼ ìœ„í•´)
          rm -rf dmsite/src/app/docs/*

          # DmNoteì˜ docs/plugin ë‚´ìš©ì„ DmSiteì˜ src/app/docsë¡œ ë³µì‚¬
          if [ -d "dmnote/docs/plugin" ]; then
            cp -r dmnote/docs/plugin/* dmsite/src/app/docs/
            echo "âœ… ë¬¸ì„œ ë™ê¸°í™” ì™„ë£Œ"
          else
            echo "âš ï¸ dmnote/docs/plugin í´ë”ê°€ ì¡´ì¬í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤"
            exit 1
          fi

          # layout.jsx ë³µì›
          if [ -f "/tmp/layout.jsx.bak" ]; then
            cp /tmp/layout.jsx.bak dmsite/src/app/docs/layout.jsx
            echo "ğŸ“¦ layout.jsx ë³µì› ì™„ë£Œ"
          fi

      - name: Check for changes
        id: check_changes
        run: |
          cd dmsite
          git add -A
          if git diff --staged --quiet; then
            echo "changes=false" >> $GITHUB_OUTPUT
            echo "ğŸ“ ë³€ê²½ì‚¬í•­ì´ ì—†ìŠµë‹ˆë‹¤"
          else
            echo "changes=true" >> $GITHUB_OUTPUT
            echo "ğŸ“ ë³€ê²½ì‚¬í•­ì´ ë°œê²¬ë˜ì—ˆìŠµë‹ˆë‹¤"
          fi

      - name: Commit and Push changes
        if: steps.check_changes.outputs.changes == 'true'
        run: |
          cd dmsite
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git commit -m "docs: DmNoteì—ì„œ ë¬¸ì„œ ë™ê¸°í™” [ìë™]"
          git push
